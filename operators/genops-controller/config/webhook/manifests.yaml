apiVersion: admissionregistration.k8s.io/v1
kind: MutatingAdmissionWebhook
metadata:
  name: genops-mutating-webhook
  labels:
    app.kubernetes.io/component: webhook
    app.kubernetes.io/created-by: genops-controller
    app.kubernetes.io/instance: mutating-webhook
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: mutatingadmissionwebhook
    app.kubernetes.io/part-of: genops-controller
webhooks:
- name: pod-injector.genops.ai
  clientConfig:
    service:
      name: genops-webhook-service
      namespace: genops-system
      path: /mutate-v1-pod
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  namespaceSelector:
    matchLabels:
      genops.ai/injection: enabled
  objectSelector:
    matchLabels:
      genops.ai/enable: "true"
  failurePolicy: Fail
  sideEffects: None
  admissionReviewVersions: ["v1", "v1beta1"]
  
- name: deployment-injector.genops.ai
  clientConfig:
    service:
      name: genops-webhook-service
      namespace: genops-system
      path: /mutate-apps-v1-deployment
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["apps"]
    apiVersions: ["v1"]
    resources: ["deployments"]
  namespaceSelector:
    matchLabels:
      genops.ai/injection: enabled
  objectSelector:
    matchLabels:
      genops.ai/enable: "true"
  failurePolicy: Fail
  sideEffects: None
  admissionReviewVersions: ["v1", "v1beta1"]

---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionWebhook
metadata:
  name: genops-validating-webhook
  labels:
    app.kubernetes.io/component: webhook
    app.kubernetes.io/created-by: genops-controller
    app.kubernetes.io/instance: validating-webhook
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: validatingadmissionwebhook
    app.kubernetes.io/part-of: genops-controller
webhooks:
- name: policy-validator.genops.ai
  clientConfig:
    service:
      name: genops-webhook-service
      namespace: genops-system
      path: /validate-v1-pod
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  namespaceSelector:
    matchLabels:
      genops.ai/policy-enforcement: enabled
  failurePolicy: Fail
  sideEffects: None
  admissionReviewVersions: ["v1", "v1beta1"]

- name: budget-validator.genops.ai
  clientConfig:
    service:
      name: genops-webhook-service
      namespace: genops-system
      path: /validate-genops-v1alpha1-aibudget
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["genops.ai"]
    apiVersions: ["v1alpha1"]
    resources: ["aibudgets"]
  failurePolicy: Fail
  sideEffects: None
  admissionReviewVersions: ["v1", "v1beta1"]

- name: aipolicy-validator.genops.ai
  clientConfig:
    service:
      name: genops-webhook-service
      namespace: genops-system
      path: /validate-genops-v1alpha1-aipolicy
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["genops.ai"]
    apiVersions: ["v1alpha1"]
    resources: ["aipolicies"]
  failurePolicy: Fail
  sideEffects: None
  admissionReviewVersions: ["v1", "v1beta1"]

- name: resource-quota.genops.ai
  clientConfig:
    service:
      name: genops-webhook-service
      namespace: genops-system
      path: /validate-resource-quota
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  namespaceSelector:
    matchLabels:
      genops.ai/resource-enforcement: enabled
  failurePolicy: Warn  # Don't block on resource quota failures
  sideEffects: None
  admissionReviewVersions: ["v1", "v1beta1"]

---
# Certificate management for webhook TLS
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: genops-webhook-cert
  namespace: genops-system
  labels:
    app.kubernetes.io/component: certificate
    app.kubernetes.io/created-by: genops-controller
    app.kubernetes.io/instance: webhook-cert
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: certificate
    app.kubernetes.io/part-of: genops-controller
spec:
  secretName: genops-webhook-server-cert
  dnsNames:
  - genops-webhook-service.genops-system.svc
  - genops-webhook-service.genops-system.svc.cluster.local
  issuerRef:
    name: genops-webhook-issuer
    kind: Issuer
    group: cert-manager.io

---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: genops-webhook-issuer
  namespace: genops-system
  labels:
    app.kubernetes.io/component: certificate
    app.kubernetes.io/created-by: genops-controller
    app.kubernetes.io/instance: webhook-issuer
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: issuer
    app.kubernetes.io/part-of: genops-controller
spec:
  ca:
    secretName: genops-webhook-ca-secret

---
# Network policy for webhook security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: genops-controller-network-policy
  namespace: genops-system
  labels:
    app.kubernetes.io/component: security
    app.kubernetes.io/created-by: genops-controller
    app.kubernetes.io/instance: network-policy
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: networkpolicy
    app.kubernetes.io/part-of: genops-controller
spec:
  podSelector:
    matchLabels:
      control-plane: controller-manager
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  # Allow webhook traffic from API server
  - from:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    - podSelector:
        matchLabels:
          component: kube-apiserver
    ports:
    - protocol: TCP
      port: 9443
  
  # Allow metrics collection
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 8080
  
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # Allow API server communication
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 6443
  
  # Allow OpenTelemetry collector communication
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          app.kubernetes.io/name: otel-collector
    ports:
    - protocol: TCP
      port: 4317
    - protocol: TCP
      port: 4318
  
  # Allow AI provider API access
  - to: []
    ports:
    - protocol: TCP
      port: 443