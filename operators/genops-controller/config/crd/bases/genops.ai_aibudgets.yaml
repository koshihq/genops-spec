apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.13.0
  name: aibudgets.genops.ai
spec:
  group: genops.ai
  names:
    kind: AIBudget
    listKind: AIBudgetList
    plural: aibudgets
    singular: aibudget
    shortNames:
    - aib
    - budget
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        description: AIBudget defines budget allocation and tracking for AI workloads
        type: object
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object.'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents.'
            type: string
          metadata:
            type: object
          spec:
            description: AIBudgetSpec defines the desired budget allocation
            type: object
            properties:
              # Budget allocation
              allocation:
                description: Budget allocation configuration
                type: object
                properties:
                  amount:
                    description: Total budget amount
                    type: number
                    format: float
                    minimum: 0
                  currency:
                    description: Currency for budget
                    type: string
                    default: "USD"
                    enum: ["USD", "EUR", "GBP", "JPY"]
                  period:
                    description: Budget period
                    type: string
                    default: "monthly"
                    enum: ["daily", "weekly", "monthly", "quarterly", "yearly"]
                  startDate:
                    description: Budget period start date
                    type: string
                    format: date-time
                  endDate:
                    description: Budget period end date
                    type: string
                    format: date-time
                  autoRenew:
                    description: Automatically renew budget for next period
                    type: boolean
                    default: true
              
              # Cost attribution
              attribution:
                description: How to attribute costs to this budget
                type: object
                properties:
                  team:
                    description: Team responsible for this budget
                    type: string
                  project:
                    description: Project this budget covers
                    type: string
                  costCenter:
                    description: Cost center for billing
                    type: string
                  environment:
                    description: Environment (dev, staging, prod)
                    type: string
                    enum: ["development", "staging", "production"]
                  customAttributes:
                    description: Custom attribution attributes
                    type: object
                    additionalProperties:
                      type: string
              
              # Usage limits
              limits:
                description: Usage limits within budget
                type: object
                properties:
                  dailySpendLimit:
                    description: Maximum daily spend
                    type: number
                    format: float
                    minimum: 0
                  weeklySpendLimit:
                    description: Maximum weekly spend
                    type: number
                    format: float
                    minimum: 0
                  perRequestLimit:
                    description: Maximum cost per request
                    type: number
                    format: float
                    minimum: 0
                  tokensPerDay:
                    description: Maximum tokens per day
                    type: integer
                    minimum: 1
                  requestsPerDay:
                    description: Maximum requests per day
                    type: integer
                    minimum: 1
                  requestsPerMinute:
                    description: Maximum requests per minute
                    type: integer
                    minimum: 1
              
              # Alerting configuration
              alerts:
                description: Budget alerting configuration
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  thresholds:
                    description: Alert thresholds as percentages
                    type: array
                    items:
                      type: object
                      properties:
                        percentage:
                          type: number
                          format: float
                          minimum: 0
                          maximum: 100
                        severity:
                          type: string
                          enum: ["info", "warning", "critical"]
                          default: "warning"
                        channels:
                          type: array
                          items:
                            type: string
                    default:
                    - percentage: 50
                      severity: "info"
                      channels: ["slack"]
                    - percentage: 80
                      severity: "warning"
                      channels: ["slack", "email"]
                    - percentage: 95
                      severity: "critical"
                      channels: ["slack", "email", "pagerduty"]
                  channels:
                    description: Available notification channels
                    type: object
                    properties:
                      slack:
                        type: object
                        properties:
                          enabled:
                            type: boolean
                            default: true
                          webhook:
                            type: string
                          channel:
                            type: string
                      email:
                        type: object
                        properties:
                          enabled:
                            type: boolean
                            default: false
                          recipients:
                            type: array
                            items:
                              type: string
                          smtp:
                            type: object
                            properties:
                              server:
                                type: string
                              port:
                                type: integer
                              username:
                                type: string
                              passwordSecret:
                                type: string
                      pagerduty:
                        type: object
                        properties:
                          enabled:
                            type: boolean
                            default: false
                          integrationKey:
                            type: string
              
              # Enforcement actions
              enforcement:
                description: Actions to take when budget is exceeded
                type: object
                properties:
                  onBudgetExceeded:
                    description: Action when budget is fully consumed
                    type: string
                    default: "throttle"
                    enum: ["alert", "throttle", "block", "approve"]
                  onDailyLimitExceeded:
                    description: Action when daily limit is exceeded
                    type: string
                    default: "throttle"
                    enum: ["alert", "throttle", "block"]
                  gracePeriod:
                    description: Grace period before enforcement (minutes)
                    type: integer
                    minimum: 0
                    default: 5
                  approvalRequired:
                    description: Require manual approval to exceed budget
                    type: boolean
                    default: false
                  approvers:
                    description: List of users who can approve budget overruns
                    type: array
                    items:
                      type: string
              
              # Provider-specific budgets
              providerBudgets:
                description: Per-provider budget allocation
                type: array
                items:
                  type: object
                  properties:
                    provider:
                      type: string
                      enum: ["openai", "anthropic", "openrouter", "bedrock", "gemini"]
                    allocation:
                      description: Budget allocation for this provider
                      type: number
                      format: float
                      minimum: 0
                    models:
                      description: Specific models covered by this budget
                      type: array
                      items:
                        type: string
                    limits:
                      description: Provider-specific limits
                      type: object
                      properties:
                        requestsPerMinute:
                          type: integer
                          minimum: 1
                        tokensPerDay:
                          type: integer
                          minimum: 1
                        costPerRequest:
                          type: number
                          format: float
                          minimum: 0
              
              # Target workloads
              selector:
                description: Selector for workloads covered by this budget
                type: object
                properties:
                  matchLabels:
                    type: object
                    additionalProperties:
                      type: string
                  matchExpressions:
                    type: array
                    items:
                      type: object
                      properties:
                        key:
                          type: string
                        operator:
                          type: string
                          enum: ["In", "NotIn", "Exists", "DoesNotExist"]
                        values:
                          type: array
                          items:
                            type: string
                  namespaces:
                    description: Namespaces covered by this budget
                    type: array
                    items:
                      type: string
            required:
            - allocation
            - attribution
            - selector
          
          status:
            description: AIBudgetStatus defines the current budget state
            type: object
            properties:
              conditions:
                description: Current conditions of the budget
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                      enum: ["True", "False", "Unknown"]
                    lastTransitionTime:
                      type: string
                      format: date-time
                    reason:
                      type: string
                    message:
                      type: string
              
              # Current usage
              usage:
                description: Current budget usage
                type: object
                properties:
                  currentSpend:
                    description: Amount spent in current period
                    type: number
                    format: float
                    default: 0
                  remainingBudget:
                    description: Remaining budget amount
                    type: number
                    format: float
                    default: 0
                  utilizationPercentage:
                    description: Budget utilization as percentage
                    type: number
                    format: float
                    default: 0
                  dailySpend:
                    description: Spend for current day
                    type: number
                    format: float
                    default: 0
                  weeklySpend:
                    description: Spend for current week
                    type: number
                    format: float
                    default: 0
                  projectedSpend:
                    description: Projected spend for full period
                    type: number
                    format: float
                    default: 0
                  lastUpdated:
                    description: Last time usage was updated
                    type: string
                    format: date-time
              
              # Usage breakdown
              breakdown:
                description: Spending breakdown by various dimensions
                type: object
                properties:
                  byProvider:
                    type: object
                    additionalProperties:
                      type: number
                      format: float
                  byModel:
                    type: object
                    additionalProperties:
                      type: number
                      format: float
                  byTeam:
                    type: object
                    additionalProperties:
                      type: number
                      format: float
                  byProject:
                    type: object
                    additionalProperties:
                      type: number
                      format: float
                  byDay:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                          format: date
                        spend:
                          type: number
                          format: float
              
              # Alerts fired
              alertsHistory:
                description: History of budget alerts
                type: array
                items:
                  type: object
                  properties:
                    timestamp:
                      type: string
                      format: date-time
                    threshold:
                      type: number
                      format: float
                    currentSpend:
                      type: number
                      format: float
                    severity:
                      type: string
                    message:
                      type: string
                    resolved:
                      type: boolean
                      default: false
              
              # Enforcement actions taken
              enforcementHistory:
                description: History of enforcement actions
                type: array
                items:
                  type: object
                  properties:
                    timestamp:
                      type: string
                      format: date-time
                    action:
                      type: string
                    reason:
                      type: string
                    duration:
                      type: string
                    affectedRequests:
                      type: integer
    
    additionalPrinterColumns:
    - name: Budget
      type: string
      description: Total budget allocation
      jsonPath: .spec.allocation.amount
    - name: Used
      type: string
      description: Amount used
      jsonPath: .status.usage.currentSpend
    - name: Remaining
      type: string
      description: Remaining budget
      jsonPath: .status.usage.remainingBudget
    - name: Utilization
      type: string
      description: Budget utilization percentage
      jsonPath: .status.usage.utilizationPercentage
    - name: Team
      type: string
      description: Team responsible
      jsonPath: .spec.attribution.team
    - name: Period
      type: string
      description: Budget period
      jsonPath: .spec.allocation.period
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
    
    subresources:
      status: {}
  conversion:
    strategy: None