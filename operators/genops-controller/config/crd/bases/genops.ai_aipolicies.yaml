apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.13.0
  name: aipolicies.genops.ai
spec:
  group: genops.ai
  names:
    kind: AIPolicy
    listKind: AIPolicyList
    plural: aipolicies
    singular: aipolicy
    shortNames:
    - aip
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        description: AIPolicy defines governance policies for AI workloads
        type: object
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation
              of an object.'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this
              object represents.'
            type: string
          metadata:
            type: object
          spec:
            description: AIPolicySpec defines the desired state of AIPolicy
            type: object
            properties:
              # Cost governance
              costLimits:
                description: Cost limits for AI operations
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  daily:
                    description: Daily cost limit in USD
                    type: number
                    format: float
                    minimum: 0
                  monthly:
                    description: Monthly cost limit in USD
                    type: number
                    format: float
                    minimum: 0
                  currency:
                    description: Currency for cost limits
                    type: string
                    default: "USD"
                    enum: ["USD", "EUR", "GBP", "JPY"]
                  enforcement:
                    description: How to enforce cost limits
                    type: string
                    default: "warn"
                    enum: ["warn", "block", "throttle"]
                  alerting:
                    description: Alert when approaching limits
                    type: object
                    properties:
                      enabled:
                        type: boolean
                        default: true
                      thresholds:
                        type: array
                        items:
                          type: number
                          format: float
                          minimum: 0
                          maximum: 100
                        default: [50, 80, 95]
              
              # Rate limiting
              rateLimits:
                description: Rate limits for AI requests
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  requestsPerMinute:
                    description: Maximum requests per minute
                    type: integer
                    minimum: 1
                    default: 60
                  requestsPerHour:
                    description: Maximum requests per hour
                    type: integer
                    minimum: 1
                    default: 3600
                  requestsPerDay:
                    description: Maximum requests per day
                    type: integer
                    minimum: 1
                  burstLimit:
                    description: Burst allowance above rate limit
                    type: integer
                    minimum: 0
                    default: 10
                  enforcement:
                    description: How to enforce rate limits
                    type: string
                    default: "throttle"
                    enum: ["warn", "block", "throttle"]
              
              # Content safety policies
              contentSafety:
                description: Content safety requirements
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  minimumSafetyScore:
                    description: Minimum required safety score (0-1)
                    type: number
                    format: float
                    minimum: 0
                    maximum: 1
                    default: 0.85
                  categories:
                    description: Safety categories to evaluate
                    type: array
                    items:
                      type: string
                      enum: ["hate", "harassment", "self-harm", "sexual", "violence"]
                    default: ["hate", "harassment", "self-harm", "sexual", "violence"]
                  enforcement:
                    description: How to enforce content safety
                    type: string
                    default: "block"
                    enum: ["warn", "block", "review"]
              
              # Data classification policies
              dataClassification:
                description: Data classification requirements
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  allowedLevels:
                    description: Allowed data classification levels
                    type: array
                    items:
                      type: string
                      enum: ["public", "internal", "confidential", "restricted"]
                    default: ["public", "internal", "confidential"]
                  requireClassification:
                    description: Require explicit data classification
                    type: boolean
                    default: true
                  enforcement:
                    description: How to enforce data classification
                    type: string
                    default: "block"
                    enum: ["warn", "block"]
              
              # Model governance
              modelGovernance:
                description: Model usage governance policies
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  allowedProviders:
                    description: Allowed AI providers
                    type: array
                    items:
                      type: string
                    default: ["openai", "anthropic", "openrouter"]
                  allowedModels:
                    description: Allowed models (regex patterns)
                    type: array
                    items:
                      type: string
                    default: ["gpt-4*", "gpt-3.5-turbo*", "claude-3*"]
                  requireApproval:
                    description: Models requiring approval
                    type: array
                    items:
                      type: string
                  costPerToken:
                    description: Maximum cost per token (USD)
                    type: object
                    properties:
                      input:
                        type: number
                        format: float
                        minimum: 0
                      output:
                        type: number
                        format: float
                        minimum: 0
              
              # Resource limits
              resourceLimits:
                description: Resource usage limits
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  maxTokensPerRequest:
                    description: Maximum tokens per request
                    type: integer
                    minimum: 1
                    default: 4000
                  maxTokensPerDay:
                    description: Maximum tokens per day
                    type: integer
                    minimum: 1
                  maxConcurrentRequests:
                    description: Maximum concurrent requests
                    type: integer
                    minimum: 1
                    default: 10
                  timeoutSeconds:
                    description: Request timeout in seconds
                    type: integer
                    minimum: 1
                    default: 300
              
              # Audit and compliance
              auditPolicy:
                description: Audit and compliance settings
                type: object
                properties:
                  enabled:
                    type: boolean
                    default: true
                  logLevel:
                    description: Audit log level
                    type: string
                    default: "info"
                    enum: ["debug", "info", "warn", "error"]
                  retention:
                    description: Audit log retention
                    type: object
                    properties:
                      days:
                        type: integer
                        minimum: 1
                        default: 90
                      events:
                        type: integer
                        minimum: 1000
                        default: 1000000
                  exportDestination:
                    description: Where to export audit logs
                    type: string
                    enum: ["stdout", "file", "s3", "gcs", "azure-blob"]
                    default: "stdout"
              
              # Target selection
              selector:
                description: Pod selector for policy application
                type: object
                properties:
                  matchLabels:
                    type: object
                    additionalProperties:
                      type: string
                  matchExpressions:
                    type: array
                    items:
                      type: object
                      properties:
                        key:
                          type: string
                        operator:
                          type: string
                          enum: ["In", "NotIn", "Exists", "DoesNotExist"]
                        values:
                          type: array
                          items:
                            type: string
            required:
            - selector
          
          status:
            description: AIPolicyStatus defines the observed state of AIPolicy
            type: object
            properties:
              conditions:
                description: Current conditions of the policy
                type: array
                items:
                  type: object
                  properties:
                    type:
                      description: Type of condition
                      type: string
                    status:
                      description: Status of condition (True, False, Unknown)
                      type: string
                      enum: ["True", "False", "Unknown"]
                    lastTransitionTime:
                      description: Last time condition transitioned
                      type: string
                      format: date-time
                    reason:
                      description: Reason for condition
                      type: string
                    message:
                      description: Human readable message
                      type: string
              appliedPods:
                description: Number of pods policy is applied to
                type: integer
                default: 0
              violations:
                description: Policy violations summary
                type: object
                properties:
                  total:
                    type: integer
                    default: 0
                  last24h:
                    type: integer
                    default: 0
                  categories:
                    type: object
                    additionalProperties:
                      type: integer
              lastUpdate:
                description: Last time policy was updated
                type: string
                format: date-time
    additionalPrinterColumns:
    - name: Cost Limit
      type: string
      description: Daily cost limit
      jsonPath: .spec.costLimits.daily
    - name: Rate Limit
      type: integer
      description: Requests per minute
      jsonPath: .spec.rateLimits.requestsPerMinute
    - name: Safety Score
      type: number
      description: Minimum safety score
      jsonPath: .spec.contentSafety.minimumSafetyScore
    - name: Applied Pods
      type: integer
      description: Number of pods policy applies to
      jsonPath: .status.appliedPods
    - name: Violations
      type: integer
      description: Total violations
      jsonPath: .status.violations.total
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
    subresources:
      status: {}
  conversion:
    strategy: None