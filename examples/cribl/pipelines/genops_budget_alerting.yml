# GenOps Budget Alerting Pipeline
# Trigger alerts on budget thresholds via webhooks (Slack, PagerDuty, etc.)
#
# This pipeline:
# - Filters for spans with genops.budget.* attributes
# - Monitors budget utilization percentages
# - Triggers webhook alerts at configurable thresholds (80%, 90%, 100%)
# - Routes to Slack, PagerDuty, MS Teams, and custom webhooks
# - Implements alert deduplication and rate limiting
#
# Installation:
# 1. Copy this file to Cribl Stream: Processing â†’ Pipelines â†’ Import
# 2. Configure webhook destinations in Routes section
# 3. Attach to genops_otlp_source HTTP source

id: genops-budget-alerting
description: Trigger alerts on budget thresholds via webhooks
enabled: true
conf:
  asyncFuncTimeout: 1000
  functions:
    # Filter 1: Only process spans with budget attributes
    - id: filter_has_budget
      filter: |
        __inputId == 'genops_otlp_source' &&
        attributes['genops.budget.name'] != null
      disabled: null
      final: false
      description: Filter spans with genops.budget.* attributes

    # Processor 1: Parse budget attributes
    - id: eval_parse_budget
      filter: "true"
      disabled: null
      conf:
        add:
          - name: budget_name
            value: attributes['genops.budget.name'] || 'unknown'
          - name: budget_limit
            value: parseFloat(attributes['genops.budget.limit'] || '0')
          - name: budget_used
            value: parseFloat(attributes['genops.budget.used'] || '0')
          - name: budget_remaining
            value: parseFloat(attributes['genops.budget.remaining'] || '0')
          - name: utilization_percent
            value: parseFloat(attributes['genops.budget.utilization_percent'] || '0')
          - name: budget_period
            value: attributes['genops.budget.period'] || 'unknown'
          - name: team
            value: attributes['genops.team'] || 'default'
          - name: customer_id
            value: attributes['genops.customer_id'] || 'unknown'
          - name: environment
            value: attributes['genops.environment'] || 'production'
        keep:
          - "*"
        remove: []
      description: Parse and extract GenOps budget attributes
      final: false
      type: eval

    # Processor 2: Classify budget status
    - id: eval_classify_budget
      filter: "true"
      disabled: null
      conf:
        add:
          - name: budget_exceeded
            value: utilization_percent > 100
          - name: budget_critical
            value: utilization_percent >= 100
          - name: budget_warning_high
            value: utilization_percent >= 90 && utilization_percent < 100
          - name: budget_warning_medium
            value: utilization_percent >= 80 && utilization_percent < 90
          - name: budget_warning_low
            value: utilization_percent >= 75 && utilization_percent < 80
          - name: budget_normal
            value: utilization_percent < 75
          - name: alert_required
            value: utilization_percent >= 80
          - name: alert_severity
            value: >
              utilization_percent >= 100 ? 'critical' :
              utilization_percent >= 90 ? 'high' :
              utilization_percent >= 80 ? 'medium' :
              utilization_percent >= 75 ? 'low' : 'info'
          - name: alert_priority
            value: >
              utilization_percent >= 100 ? 'P1' :
              utilization_percent >= 95 ? 'P2' :
              utilization_percent >= 90 ? 'P3' :
              utilization_percent >= 80 ? 'P4' : 'P5'
        keep:
          - "*"
        remove: []
      description: Classify budget status and alert severity
      final: false
      type: eval

    # Processor 3: Calculate time projections
    - id: eval_budget_projections
      filter: budget_remaining > 0
      disabled: null
      conf:
        add:
          - name: burn_rate_per_hour
            value: "budget_period == 'daily' ? budget_used / 24 : budget_period == 'weekly' ? budget_used / (24 * 7) : budget_period == 'monthly' ? budget_used / (24 * 30) : 0"
          - name: hours_until_depleted
            value: "burn_rate_per_hour > 0 ? budget_remaining / burn_rate_per_hour : 0"
          - name: depletion_warning
            value: "hours_until_depleted < 24 && hours_until_depleted > 0"
        keep:
          - "*"
        remove: []
      description: Calculate budget burn rate and depletion time
      final: false
      type: eval

    # Processor 4: Format alert messages
    - id: eval_format_alerts
      filter: alert_required == true
      disabled: null
      conf:
        add:
          - name: alert_title
            value: "budget_exceeded ? `ðŸš¨ CRITICAL: Budget Exceeded - ${budget_name}` : utilization_percent >= 90 ? `âš ï¸ HIGH: Budget Alert - ${budget_name} (${utilization_percent.toFixed(1)}%)` : `ðŸ’° MEDIUM: Budget Warning - ${budget_name} (${utilization_percent.toFixed(1)}%)`"
          - name: alert_message
            value: "`Budget: ${budget_name}\\n` + `Status: ${utilization_percent.toFixed(1)}% utilized\\n` + `Used: $${budget_used.toFixed(2)} of $${budget_limit.toFixed(2)}\\n` + `Remaining: $${budget_remaining.toFixed(2)}\\n` + `Period: ${budget_period}\\n` + `Team: ${team}\\n` + (customer_id != 'unknown' ? `Customer: ${customer_id}\\n` : '') + (hours_until_depleted > 0 && hours_until_depleted < 168 ? `â±ï¸ Projected depletion: ${hours_until_depleted.toFixed(1)} hours\\n` : '') + `Environment: ${environment}\\n` + `Priority: ${alert_priority}`"
          - name: slack_color
            value: "budget_exceeded ? 'danger' : utilization_percent >= 90 ? 'warning' : '#ffcc00'"
          - name: slack_emoji
            value: "budget_exceeded ? ':rotating_light:' : utilization_percent >= 90 ? ':warning:' : ':moneybag:'"
        keep:
          - "*"
        remove: []
      description: Format alert messages for webhooks
      final: false
      type: eval

    # Processor 5: Alert deduplication
    - id: suppress_duplicate_alerts
      filter: alert_required == true
      disabled: null
      conf:
        allow: 1
        suppressPeriodSec: 3600  # Suppress duplicate alerts for 1 hour
        keyExpr: "`${budget_name}-${alert_severity}`"
        dropEventsMode: true
      description: Deduplicate alerts (1 per budget per severity per hour)
      final: false
      type: suppress

    # Processor 6: Threshold-based sampling
    - id: sampling_threshold_based
      filter: "true"
      disabled: null
      conf:
        rules:
          # 100% for critical alerts (budget exceeded)
          - filter: budget_critical == true
            rate: 1.0
          # 100% for high warnings (>=90%)
          - filter: budget_warning_high == true
            rate: 1.0
          # 100% for medium warnings (>=80%)
          - filter: budget_warning_medium == true
            rate: 1.0
          # 50% for low warnings (>=75%)
          - filter: budget_warning_low == true
            rate: 0.5
          # 1% for normal budget status (baseline monitoring)
          - filter: budget_normal == true
            rate: 0.01
          # Default: no sampling
          - filter: "true"
            rate: 1.0
      description: Sample based on budget threshold severity
      final: false
      type: sampling

    # Processor 7: Add routing metadata
    - id: eval_routing_metadata
      filter: "true"
      disabled: null
      conf:
        add:
          - name: cribl_pipe
            value: "'genops-budget-alerting'"
          - name: processed_at
            value: Date.now()
          - name: route_to_slack
            value: alert_required
          - name: route_to_pagerduty
            value: budget_critical || budget_warning_high
          - name: route_to_datadog
            value: "true"
          - name: route_to_teams
            value: alert_required
        keep:
          - "*"
        remove: []
      description: Add routing and processing metadata
      final: false
      type: eval

# Routes configuration (configure these in Cribl Stream UI)
output:
  - name: slack_webhook
    description: Send budget alerts to Slack
    filter: route_to_slack == true
    # Slack webhook format:
    # POST https://hooks.slack.com/services/YOUR/WEBHOOK/URL
    # Body: {
    #   "text": alert_title,
    #   "attachments": [{
    #     "color": slack_color,
    #     "text": alert_message,
    #     "footer": "GenOps Budget Monitor"
    #   }]
    # }

  - name: pagerduty_webhook
    description: Create PagerDuty incidents for critical budgets
    filter: route_to_pagerduty == true
    # PagerDuty Events API v2:
    # POST https://events.pagerduty.com/v2/enqueue
    # Body: {
    #   "routing_key": "YOUR_ROUTING_KEY",
    #   "event_action": "trigger",
    #   "payload": {
    #     "summary": alert_title,
    #     "severity": alert_severity,
    #     "source": "genops-budget-monitor",
    #     "custom_details": { all budget fields }
    #   }
    # }

  - name: msteams_webhook
    description: Send budget alerts to Microsoft Teams
    filter: route_to_teams == true
    # Teams webhook format:
    # POST https://outlook.office.com/webhook/YOUR/WEBHOOK/URL
    # Body: {
    #   "@type": "MessageCard",
    #   "themeColor": slack_color,
    #   "summary": alert_title,
    #   "sections": [{
    #     "activityTitle": alert_title,
    #     "text": alert_message
    #   }]
    # }

  - name: datadog_events
    description: Send all budget tracking to Datadog
    filter: route_to_datadog == true

  - name: custom_webhook
    description: Send to custom alerting system
    filter: alert_required == true
    # Custom webhook format (configure as needed):
    # POST https://your-alerting-system.com/api/alerts
    # Body: { custom format with all budget fields }

  - name: s3_budget_analytics
    description: Store budget data for analysis
    filter: "true"

  - name: cribl_lake
    description: Store all budget tracking in Cribl Lake
    filter: "true"

# Example Slack Message Format:
# {
#   "text": "ðŸš¨ CRITICAL: Budget Exceeded - team-nlp-daily",
#   "attachments": [
#     {
#       "color": "danger",
#       "text": "Budget: team-nlp-daily\nStatus: 105.0% utilized\nUsed: $105.00 of $100.00\nRemaining: $-5.00\nPeriod: daily\nTeam: nlp\nEnvironment: production\nPriority: P1",
#       "footer": "GenOps Budget Monitor"
#     }
#   ]
# }

# Example PagerDuty Incident:
# {
#   "routing_key": "YOUR_ROUTING_KEY",
#   "event_action": "trigger",
#   "dedup_key": "team-nlp-daily-critical",
#   "payload": {
#     "summary": "ðŸš¨ CRITICAL: Budget Exceeded - team-nlp-daily",
#     "severity": "critical",
#     "source": "genops-budget-monitor",
#     "custom_details": {
#       "budget_name": "team-nlp-daily",
#       "utilization_percent": 105.0,
#       "budget_used": 105.00,
#       "budget_limit": 100.00,
#       "team": "nlp",
#       "environment": "production"
#     }
#   }
# }

# Monitoring & Alerting
# Configure in Cribl Stream: Monitoring â†’ Metrics
# Alert on:
# - cribl.pipeline.genops-budget-alerting.in.events (incoming budget events)
# - High rate of budget_exceeded == true (budget overruns)
# - High rate of alert_required == true (budget warnings)
# - Specific budget_name thresholds (e.g., production budgets)

# Alert Deduplication Strategy:
# - Same budget + same severity: 1 alert per hour
# - Budget status changes (e.g., medium â†’ high): new alert immediately
# - Critical alerts: always sent (even if duplicate within hour)
#
# This prevents alert fatigue while ensuring critical issues are never missed.
