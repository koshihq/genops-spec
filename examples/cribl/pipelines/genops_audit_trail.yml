# GenOps Compliance Audit Trail Pipeline
# Preserve audit trail for compliance in data lakes and long-term storage
#
# This pipeline:
# - Filters for spans with genops.compliance.* attributes
# - Routes to compliant long-term storage (S3, Snowflake, Cribl Lake)
# - Implements compliance-specific retention policies
# - Adds immutable audit metadata (timestamps, checksums)
# - Supports HIPAA, GDPR, SOC2, PCI-DSS, and other frameworks
#
# Installation:
# 1. Copy this file to Cribl Stream: Processing → Pipelines → Import
# 2. Configure data lake destinations in Routes section
# 3. Attach to genops_otlp_source HTTP source

id: genops-audit-trail
description: Preserve audit trail for compliance in data lakes
enabled: true
conf:
  asyncFuncTimeout: 1000
  functions:
    # Filter 1: Only process spans requiring audit trail
    - id: filter_audit_required
      filter: |
        __inputId == 'genops_otlp_source' &&
        (attributes['genops.compliance.audit_trail_required'] == 'true' ||
         attributes['genops.compliance.framework'] != null)
      disabled: null
      final: false
      description: Filter spans requiring compliance audit trail

    # Processor 1: Parse compliance attributes
    - id: eval_parse_compliance
      filter: "true"
      disabled: null
      conf:
        add:
          - name: compliance_framework
            value: attributes['genops.compliance.framework'] || 'unknown'
          - name: data_classification
            value: attributes['genops.compliance.data_classification'] || 'unknown'
          - name: retention_years
            value: parseInt(attributes['genops.compliance.retention_years'] || '7')
          - name: audit_trail_required
            value: attributes['genops.compliance.audit_trail_required'] == 'true'
          - name: customer_id
            value: attributes['genops.customer_id'] || 'unknown'
          - name: team
            value: attributes['genops.team'] || 'default'
          - name: environment
            value: attributes['genops.environment'] || 'production'
          - name: operation_name
            value: attributes['operation.name'] || name || 'unknown'
        keep:
          - "*"
        remove: []
      description: Parse and extract GenOps compliance attributes
      final: false
      type: eval

    # Processor 2: Enrich with compliance requirements
    - id: lookup_compliance_requirements
      filter: compliance_framework != 'unknown'
      disabled: null
      conf:
        matchMode: exact
        reloadPeriodSec: 3600  # Reload every hour
        addToEvent:
          - inFieldName: framework_full_name
            outFieldName: compliance_framework_name
          - inFieldName: default_retention_years
            outFieldName: framework_retention_years
          - inFieldName: encryption_required
            outFieldName: requires_encryption
          - inFieldName: access_logging_required
            outFieldName: requires_access_logging
          - inFieldName: geographic_restrictions
            outFieldName: data_residency_requirements
        ignoreCase: false
        matchType: specific
        inFields:
          - eventField: compliance_framework
            lookupField: framework_code
        file: compliance_requirements.csv
      description: Enrich with compliance framework requirements
      final: false
      type: lookup

    # Processor 3: Add immutable audit metadata
    - id: eval_audit_metadata
      filter: "true"
      disabled: null
      conf:
        add:
          - name: audit_id
            value: "`${Date.now()}-${Math.random().toString(36).substr(2, 9)}`"
          - name: audit_timestamp
            value: Date.now()
          - name: audit_iso_timestamp
            value: new Date().toISOString()
          - name: audit_year
            value: new Date().getFullYear()
          - name: audit_month
            value: new Date().getMonth() + 1
          - name: audit_day
            value: new Date().getDate()
          - name: retention_until_timestamp
            value: Date.now() + (retention_years * 365 * 24 * 60 * 60 * 1000)
          - name: retention_until_date
            value: >
              new Date(Date.now() + (retention_years * 365 * 24 * 60 * 60 * 1000)).toISOString()
          - name: audit_source
            value: "'genops-ai'"
          - name: audit_pipeline
            value: "'cribl-genops-audit-trail'"
        keep:
          - "*"
        remove: []
      description: Add immutable audit trail metadata
      final: false
      type: eval

    # Processor 4: Calculate audit checksums
    - id: eval_audit_checksums
      filter: "true"
      disabled: null
      conf:
        add:
          - name: audit_data_hash
            value: >
              crypto.createHash('sha256')
                .update(JSON.stringify({
                  operation_name,
                  customer_id,
                  compliance_framework,
                  data_classification,
                  audit_timestamp
                }))
                .digest('hex')
        keep:
          - "*"
        remove: []
      description: Calculate audit data checksums for integrity
      final: false
      type: eval

    # Processor 5: Classify data sensitivity
    - id: eval_classify_sensitivity
      filter: "true"
      disabled: null
      conf:
        add:
          - name: is_phi
            value: >
              compliance_framework == 'HIPAA' ||
              data_classification.toLowerCase().includes('phi') ||
              data_classification.toLowerCase().includes('health')
          - name: is_pii
            value: >
              compliance_framework == 'GDPR' ||
              data_classification.toLowerCase().includes('pii') ||
              data_classification.toLowerCase().includes('personal')
          - name: is_pci
            value: >
              compliance_framework == 'PCI-DSS' ||
              data_classification.toLowerCase().includes('payment') ||
              data_classification.toLowerCase().includes('card')
          - name: is_financial
            value: >
              compliance_framework == 'SOC2' ||
              data_classification.toLowerCase().includes('financial')
          - name: sensitivity_level
            value: >
              is_phi || is_pci ? 'highly_sensitive' :
              is_pii || is_financial ? 'sensitive' :
              'standard'
        keep:
          - "*"
        remove: []
      description: Classify data sensitivity for routing
      final: false
      type: eval

    # Processor 6: Geographic routing classification
    - id: eval_geographic_routing
      filter: "true"
      disabled: null
      conf:
        add:
          - name: requires_eu_storage
            value: >
              compliance_framework == 'GDPR' ||
              (data_residency_requirements != null &&
               data_residency_requirements.includes('EU'))
          - name: requires_us_storage
            value: >
              compliance_framework == 'HIPAA' ||
              compliance_framework == 'SOC2' ||
              (data_residency_requirements != null &&
               data_residency_requirements.includes('US'))
          - name: storage_region
            value: >
              requires_eu_storage ? 'eu' :
              requires_us_storage ? 'us' : 'global'
        keep:
          - "*"
        remove: []
      description: Determine geographic storage requirements
      final: false
      type: eval

    # Processor 7: Format for long-term storage
    - id: eval_storage_formatting
      filter: "true"
      disabled: null
      conf:
        add:
          - name: s3_bucket_prefix
            value: "`compliance-audit/${compliance_framework.toLowerCase()}/${audit_year}/${audit_month}`"
          - name: s3_object_key
            value: "`${audit_day}/${audit_id}.json`"
          - name: snowflake_table
            value: "`compliance_audit.${compliance_framework.toLowerCase()}_events`"
          - name: partition_date
            value: "`${audit_year}-${audit_month.toString().padStart(2, '0')}-${audit_day.toString().padStart(2, '0')}`"
        keep:
          - "*"
        remove: []
      description: Format metadata for data lake storage
      final: false
      type: eval

    # Processor 8: No sampling for compliance data
    - id: sampling_compliance
      filter: "true"
      disabled: null
      conf:
        rules:
          # 100% sampling for all compliance audit data
          # Compliance requirements mandate complete audit trails
          - filter: "true"
            rate: 1.0
      description: No sampling - compliance requires complete audit trail
      final: false
      type: sampling

    # Processor 9: Add routing metadata
    - id: eval_routing_metadata
      filter: "true"
      disabled: null
      conf:
        add:
          - name: cribl_pipe
            value: "'genops-audit-trail'"
          - name: processed_at
            value: Date.now()
          - name: route_to_s3
            value: "true"
          - name: route_to_snowflake
            value: "true"
          - name: route_to_cribl_lake
            value: "true"
          - name: route_to_archive
            value: sensitivity_level == 'highly_sensitive'
        keep:
          - "*"
        remove: []
      description: Add routing and processing metadata
      final: false
      type: eval

# Routes configuration (configure these in Cribl Stream UI)
output:
  - name: s3_compliance_us
    description: S3 bucket for US compliance audit (HIPAA, SOC2)
    filter: storage_region == 'us' || storage_region == 'global'
    # S3 configuration:
    # - Bucket: genops-compliance-audit-us
    # - Prefix: ${s3_bucket_prefix}/${s3_object_key}
    # - Versioning: Enabled
    # - Encryption: AES-256 or KMS
    # - Lifecycle: Transition to Glacier after 90 days, retain per retention_years
    # - Access Logging: Enabled
    # - Bucket Policy: Enforce encryption, deny unencrypted uploads

  - name: s3_compliance_eu
    description: S3 bucket for EU compliance audit (GDPR)
    filter: storage_region == 'eu'
    # S3 configuration:
    # - Bucket: genops-compliance-audit-eu
    # - Region: eu-central-1 or eu-west-1
    # - Prefix: ${s3_bucket_prefix}/${s3_object_key}
    # - Versioning: Enabled
    # - Encryption: AES-256 or KMS
    # - Lifecycle: Transition to Glacier after 90 days, retain per retention_years
    # - Access Logging: Enabled

  - name: snowflake_compliance
    description: Snowflake for queryable compliance audit
    filter: "true"
    # Snowflake configuration:
    # - Database: COMPLIANCE_AUDIT
    # - Schema: GENOPS_EVENTS
    # - Tables: hipaa_events, gdpr_events, soc2_events, pci_events
    # - Partitioning: By audit_year, audit_month, audit_day
    # - Time Travel: Enabled (retention_years)
    # - Fail-safe: 7 days minimum
    # - Encryption: Always encrypted at rest

  - name: cribl_lake_compliance
    description: Cribl Lake for searchable compliance archive
    filter: "true"
    # Cribl Lake configuration:
    # - Dataset: genops-compliance-audit
    # - Partitioning: By compliance_framework, audit_year, audit_month
    # - Retention: Per retention_years from lookup
    # - Compression: Parquet with Snappy
    # - Encryption: Enabled

  - name: azure_blob_compliance
    description: Azure Blob Storage for multi-cloud redundancy
    filter: sensitivity_level == 'highly_sensitive'
    # Azure configuration:
    # - Storage Account: genopscompliance
    # - Container: compliance-audit
    # - Immutability Policy: WORM (Write Once Read Many)
    # - Retention: Per retention_years
    # - Encryption: Always encrypted
    # - Geo-redundancy: Enabled for highly_sensitive data

  - name: glacier_deep_archive
    description: AWS Glacier Deep Archive for long-term retention
    filter: retention_years >= 7
    # Glacier configuration:
    # - Vault: genops-compliance-long-term
    # - Retrieval: Expedited/Standard/Bulk
    # - Retention Lock: Enabled (immutable for retention_years)
    # - Encryption: AES-256

# Example lookup table: compliance_requirements.csv
# Create this file in Cribl Stream: Knowledge → Lookups → Add Lookup File
#
# framework_code,framework_full_name,default_retention_years,encryption_required,access_logging_required,geographic_restrictions
# HIPAA,Health Insurance Portability and Accountability Act,7,true,true,US
# GDPR,General Data Protection Regulation,7,true,true,EU
# SOC2,Service Organization Control 2,7,true,true,US
# PCI-DSS,Payment Card Industry Data Security Standard,5,true,true,GLOBAL
# CCPA,California Consumer Privacy Act,5,true,true,US-CA
# ISO27001,Information Security Management System,3,true,false,GLOBAL
# FERPA,Family Educational Rights and Privacy Act,5,true,true,US

# Compliance Storage Best Practices:
#
# 1. Immutability:
#    - S3: Object Lock with Compliance mode
#    - Azure: WORM (Write Once Read Many) policy
#    - Snowflake: Time Travel retention
#
# 2. Encryption:
#    - At rest: AES-256 or KMS
#    - In transit: TLS 1.2+
#    - Key rotation: Annual or per framework requirements
#
# 3. Access Control:
#    - Least privilege access
#    - MFA for admin access
#    - Audit all data access
#    - Segregate by compliance framework
#
# 4. Geographic Compliance:
#    - GDPR: Store in EU regions only
#    - HIPAA: Store in US regions only
#    - Multi-region: Replicate with encryption
#
# 5. Retention:
#    - HIPAA: 7 years minimum
#    - GDPR: 7 years or per member state law
#    - SOC2: 7 years recommended
#    - PCI-DSS: 5 years minimum
#
# 6. Audit Trail:
#    - Log all access to audit data
#    - Preserve access logs for same retention period
#    - Immutable audit logs
#    - Regular compliance audits

# Monitoring & Alerting
# Configure in Cribl Stream: Monitoring → Metrics
# Alert on:
# - cribl.pipeline.genops-audit-trail.in.events (incoming audit events)
# - Failed storage writes (S3/Snowflake/Cribl Lake errors)
# - Encryption failures
# - Geographic routing violations
# - High rate of highly_sensitive data

# Compliance Validation Queries:
#
# Snowflake query to validate audit completeness:
# SELECT
#   compliance_framework,
#   COUNT(*) as event_count,
#   MIN(audit_timestamp) as earliest_event,
#   MAX(audit_timestamp) as latest_event,
#   COUNT(DISTINCT customer_id) as unique_customers
# FROM compliance_audit.genops_events
# WHERE audit_year = YEAR(CURRENT_DATE())
# GROUP BY compliance_framework;
#
# S3 lifecycle check:
# aws s3api get-bucket-lifecycle-configuration \
#   --bucket genops-compliance-audit-us
#
# Verify retention policies match compliance requirements.
