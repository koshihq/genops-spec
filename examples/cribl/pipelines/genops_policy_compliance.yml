# GenOps Policy & Compliance Pipeline
# Route GenOps policy evaluation events to SIEM and security platforms
#
# This pipeline:
# - Filters for spans with genops.policy.* attributes
# - Classifies policy results (allowed, warning, blocked)
# - Routes violations and warnings to SIEM (Splunk, Elastic, Sentinel)
# - Implements severity-based sampling
# - Enriches with compliance framework metadata
#
# Installation:
# 1. Copy this file to Cribl Stream: Processing → Pipelines → Import
# 2. Configure SIEM destinations in Routes section
# 3. Attach to genops_otlp_source HTTP source

id: genops-policy-compliance
description: Route GenOps policy and compliance events to SIEM
enabled: true
conf:
  asyncFuncTimeout: 1000
  functions:
    # Filter 1: Only process spans with policy attributes
    - id: filter_has_policy
      filter: |
        __inputId == 'genops_otlp_source' &&
        attributes['genops.policy.name'] != null
      disabled: null
      final: false
      description: Filter spans with genops.policy.* attributes

    # Processor 1: Parse policy attributes
    - id: eval_parse_policy
      filter: "true"
      disabled: null
      conf:
        add:
          - name: policy_name
            value: attributes['genops.policy.name'] || 'unknown'
          - name: policy_result
            value: attributes['genops.policy.result'] || 'unknown'
          - name: policy_reason
            value: attributes['genops.policy.reason'] || 'No reason provided'
          - name: policy_severity
            value: attributes['genops.policy.severity'] || 'info'
          - name: compliance_framework
            value: attributes['genops.compliance.framework'] || 'unknown'
          - name: customer_id
            value: attributes['genops.customer_id'] || 'unknown'
          - name: team
            value: attributes['genops.team'] || 'default'
          - name: environment
            value: attributes['genops.environment'] || 'production'
          - name: evaluated_at
            value: attributes['genops.policy.evaluated_at'] || Date.now()
        keep:
          - "*"
        remove: []
      description: Parse and extract GenOps policy attributes
      final: false
      type: eval

    # Processor 2: Classify policy violations
    - id: eval_classify_violations
      filter: "true"
      disabled: null
      conf:
        add:
          - name: is_violation
            value: policy_result == 'blocked' || policy_result == 'warning'
          - name: is_critical
            value: policy_result == 'blocked' && policy_severity == 'high'
          - name: requires_siem_routing
            value: policy_result == 'blocked' || policy_result == 'warning'
          - name: requires_incident
            value: policy_result == 'blocked' && policy_severity == 'high'
          - name: violation_category
            value: >
              policy_result == 'blocked' ? 'security_violation' :
              policy_result == 'warning' ? 'policy_warning' :
              'policy_allowed'
        keep:
          - "*"
        remove: []
      description: Classify policy evaluation results
      final: false
      type: eval

    # Processor 3: Enrich with compliance metadata
    - id: lookup_compliance_metadata
      filter: compliance_framework != 'unknown'
      disabled: null
      conf:
        matchMode: exact
        reloadPeriodSec: 300
        addToEvent:
          - inFieldName: framework_description
            outFieldName: compliance_description
          - inFieldName: retention_years
            outFieldName: audit_retention_years
          - inFieldName: requires_notification
            outFieldName: requires_compliance_notification
        ignoreCase: false
        matchType: specific
        inFields:
          - eventField: compliance_framework
            lookupField: framework_name
        file: compliance_frameworks.csv
      description: Enrich with compliance framework requirements
      final: false
      type: lookup

    # Processor 4: Severity-based sampling
    - id: sampling_severity_based
      filter: "true"
      disabled: null
      conf:
        rules:
          # 100% sampling for critical violations (blocked + high severity)
          - filter: is_critical == true
            rate: 1.0
          # 100% sampling for all blocked policies
          - filter: policy_result == 'blocked'
            rate: 1.0
          # 100% sampling for high-severity warnings
          - filter: policy_result == 'warning' && policy_severity == 'high'
            rate: 1.0
          # 50% sampling for medium-severity warnings
          - filter: policy_result == 'warning' && policy_severity == 'medium'
            rate: 0.5
          # 10% sampling for low-severity warnings
          - filter: policy_result == 'warning'
            rate: 0.1
          # 1% sampling for allowed policies (baseline monitoring)
          - filter: policy_result == 'allowed'
            rate: 0.01
          # Default: no sampling
          - filter: "true"
            rate: 1.0
      description: Intelligent sampling based on violation severity
      final: false
      type: sampling

    # Processor 5: Format for SIEM
    - id: eval_siem_formatting
      filter: requires_siem_routing == true
      disabled: null
      conf:
        add:
          - name: siem_event_type
            value: "'genops_policy_violation'"
          - name: siem_severity
            value: >
              policy_result == 'blocked' && policy_severity == 'high' ? 'critical' :
              policy_result == 'blocked' ? 'high' :
              policy_severity == 'high' ? 'medium' :
              policy_severity == 'medium' ? 'low' : 'info'
          - name: siem_title
            value: "`GenOps Policy ${policy_result.toUpperCase()}: ${policy_name}`"
          - name: siem_description
            value: >
              `Policy ${policy_name} result: ${policy_result}. Reason: ${policy_reason}.
              Framework: ${compliance_framework}. Customer: ${customer_id}.`
          - name: alert_priority
            value: >
              is_critical ? 'P1' :
              policy_result == 'blocked' ? 'P2' :
              policy_severity == 'high' ? 'P3' : 'P4'
        keep:
          - "*"
        remove: []
      description: Format policy events for SIEM ingestion
      final: false
      type: eval

    # Processor 6: PII masking (if needed)
    - id: mask_sensitive_data
      filter: policy_reason.includes('PII') || policy_reason.includes('sensitive')
      disabled: null
      conf:
        rules:
          - matchRegex: /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i
            replaceExpr: "'<EMAIL_REDACTED>'"
          - matchRegex: /\b\d{3}-\d{2}-\d{4}\b/
            replaceExpr: "'<SSN_REDACTED>'"
          - matchRegex: /\b\d{16}\b/
            replaceExpr: "'<CARD_REDACTED>'"
        fields:
          - policy_reason
          - siem_description
      description: Mask PII in policy violation descriptions
      final: false
      type: mask

    # Processor 7: Add routing metadata
    - id: eval_routing_metadata
      filter: "true"
      disabled: null
      conf:
        add:
          - name: cribl_pipe
            value: "'genops-policy-compliance'"
          - name: processed_at
            value: Date.now()
          - name: route_to_siem
            value: requires_siem_routing
          - name: route_to_incident_mgmt
            value: requires_incident
          - name: route_to_monitoring
            value: "true"
        keep:
          - "*"
        remove: []
      description: Add routing and processing metadata
      final: false
      type: eval

# Routes configuration (configure these in Cribl Stream UI)
output:
  - name: splunk_hec
    description: Send violations to Splunk SIEM
    filter: route_to_siem == true
  - name: elastic_security
    description: Send violations to Elastic Security
    filter: route_to_siem == true
  - name: azure_sentinel
    description: Send violations to Azure Sentinel
    filter: route_to_siem == true
  - name: pagerduty_webhook
    description: Create incidents for critical violations
    filter: route_to_incident_mgmt == true
  - name: datadog_events
    description: Send all policy events to Datadog for monitoring
    filter: route_to_monitoring == true
  - name: s3_compliance_audit
    description: Store all policy events for compliance audit
    filter: compliance_framework != 'unknown'
  - name: cribl_lake
    description: Store all policy events in Cribl Lake
    filter: "true"

# Example lookup table: compliance_frameworks.csv
# Create this file in Cribl Stream: Knowledge → Lookups → Add Lookup File
#
# framework_name,framework_description,retention_years,requires_notification
# HIPAA,Health Insurance Portability and Accountability Act,7,true
# GDPR,General Data Protection Regulation,7,true
# SOC2,Service Organization Control 2,7,false
# PCI-DSS,Payment Card Industry Data Security Standard,5,true
# CCPA,California Consumer Privacy Act,5,true
# ISO27001,Information Security Management,3,false

# Monitoring & Alerting
# Configure in Cribl Stream: Monitoring → Metrics
# Alert on:
# - cribl.pipeline.genops-policy-compliance.in.events (incoming policy events)
# - High rate of is_violation == true (security incidents)
# - High rate of is_critical == true (critical violations)
# - Specific policy_name violations (e.g., 'content_safety', 'pii_detection')

# SIEM Integration Notes:
# - Splunk: Use HTTP Event Collector (HEC) with proper sourcetype
# - Elastic: Use Elasticsearch destination with security indices
# - Sentinel: Use Azure Log Analytics workspace
# - All SIEM destinations should preserve genops.* attributes for investigation
