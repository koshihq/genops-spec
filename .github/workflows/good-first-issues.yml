name: Good First Issues Management

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  pull_request:
    types: [opened, closed]
  schedule:
    - cron: '0 10 * * 1'  # Every Monday at 10 AM UTC
  workflow_dispatch: {}

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  auto-label-issues:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Label new issues
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body ? issue.body.toLowerCase() : '';
            
            const labels = [];
            
            // Auto-label based on keywords
            if (title.includes('bug') || body.includes('bug') || body.includes('error')) {
              labels.push('bug');
            }
            
            if (title.includes('feature') || title.includes('enhancement') || body.includes('feature request')) {
              labels.push('enhancement');
            }
            
            if (title.includes('doc') || title.includes('documentation') || body.includes('documentation')) {
              labels.push('documentation');
            }
            
            if (title.includes('test') || body.includes('test') || body.includes('testing')) {
              labels.push('testing');
            }
            
            if (title.includes('ci') || title.includes('github action') || body.includes('workflow')) {
              labels.push('ci/cd');
            }
            
            // Good first issue indicators
            const goodFirstIssueKeywords = [
              'typo', 'typos', 'spelling', 
              'add test', 'missing test', 'test coverage',
              'documentation', 'readme', 'example',
              'simple', 'easy', 'beginner',
              'help wanted'
            ];
            
            const isGoodFirstIssue = goodFirstIssueKeywords.some(keyword => 
              title.includes(keyword) || body.includes(keyword)
            );
            
            if (isGoodFirstIssue) {
              labels.push('good first issue');
              labels.push('help wanted');
            }
            
            // Add priority labels based on keywords
            if (title.includes('urgent') || title.includes('critical') || body.includes('production')) {
              labels.push('priority: high');
            } else if (title.includes('nice to have') || body.includes('enhancement')) {
              labels.push('priority: low');
            } else {
              labels.push('priority: medium');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

  create-good-first-issues:
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create follow-up good first issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Check if this PR could spawn good first issues
            const title = pr.title.toLowerCase();
            const body = pr.body ? pr.body.toLowerCase() : '';
            
            const followUpIssues = [];
            
            // New feature -> documentation needed
            if (title.includes('add') || title.includes('implement') || title.includes('feature')) {
              followUpIssues.push({
                title: `ðŸ“– Add documentation for ${pr.title.replace(/^(add|implement|feature:?\s*)/i, '')}`,
                body: `This PR (#${pr.number}) added new functionality that needs documentation.

            **Tasks:**
            - [ ] Add docstrings to new functions/classes
            - [ ] Update README if needed
            - [ ] Add examples in \`examples/\` directory
            - [ ] Update API documentation

            **Related PR:** #${pr.number}

            This is a great first issue for someone wanting to contribute to documentation!`.replace(/^ +/gm, ''),
                labels: ['good first issue', 'documentation', 'help wanted', 'priority: medium']
              });
            }
            
            // New provider adapter -> tests needed
            if (title.includes('provider') || title.includes('adapter')) {
              followUpIssues.push({
                title: `ðŸ§ª Add comprehensive tests for ${pr.title.replace(/^(add|implement|feature:?\s*)/i, '')}`,
                body: `This PR (#${pr.number}) added a new provider adapter that needs more test coverage.

            **Tasks:**
            - [ ] Add unit tests for edge cases
            - [ ] Add property-based tests using Hypothesis
            - [ ] Add integration tests
            - [ ] Ensure 100% code coverage for the new adapter

            **Related PR:** #${pr.number}

            Perfect for someone wanting to learn about testing patterns in GenOps AI!`.replace(/^ +/gm, ''),
                labels: ['good first issue', 'testing', 'help wanted', 'priority: medium']
              });
            }
            
            // Create the issues
            for (const issue of followUpIssues) {
              try {
                const response = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issue.title,
                  body: issue.body,
                  labels: issue.labels
                });
                
                console.log(`Created follow-up issue: ${response.data.html_url}`);
              } catch (error) {
                console.error('Failed to create issue:', error);
              }
            }

  maintain-good-first-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - name: Audit and maintain good first issues
        uses: actions/github-script@v7
        with:
          script: |
            // Get all open issues with 'good first issue' label
            const goodFirstIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'good first issue',
              per_page: 100
            });
            
            console.log(`Found ${goodFirstIssues.data.length} good first issues`);
            
            for (const issue of goodFirstIssues.data) {
              const age = Date.now() - new Date(issue.created_at).getTime();
              const daysOld = age / (1000 * 60 * 60 * 24);
              
              // Add helpful comments to stale good first issues
              if (daysOld > 30 && !issue.assignee) {
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number
                });
                
                const hasMaintenanceComment = comments.data.some(comment => 
                  comment.body.includes('This good first issue is still available')
                );
                
                if (!hasMaintenanceComment) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `ðŸ‘‹ This good first issue is still available and is a great way to get started contributing to GenOps AI!

                    **Getting started:**
                    1. Comment on this issue to let us know you're working on it
                    2. Fork the repository
                    3. Check out our [Contributing Guide](../blob/main/CONTRIBUTING.md)
                    4. Ask questions if you need help!

                    **Need help?** Feel free to ask questions in this issue or in our [GitHub Discussions](https://github.com/KoshiHQ/GenOps-AI/discussions).`.replace(/^ +/gm, '')
                  });
                }
              }
              
              // Remove 'good first issue' label from complex issues (heuristic check)
              if (issue.comments > 10 || daysOld > 90) {
                const hasComplexLabels = issue.labels.some(label => 
                  ['priority: high', 'breaking change', 'architecture'].includes(label.name)
                );
                
                if (hasComplexLabels) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: 'good first issue'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `ðŸ”„ Removed "good first issue" label as this issue has grown in complexity. Thanks to everyone who has contributed to the discussion!`
                  });
                }
              }
            }
