name: Contributors

on:
  issues:
    types: [opened, closed]
  pull_request_target:
    types: [opened, closed]
  push:
    branches: [main]
  
permissions:
  contents: write
  pull-requests: write

jobs:
  contributors:
    if: github.repository == 'KoshiHQ/GenOps-AI'
    runs-on: ubuntu-latest
    name: Add contributors

    steps:
      - name: Contribute List
        uses: akhilmhdh/contributors-readme-action@v2.3.6
        with:
          image_size: 100
          readme_path: 'README.md'
          columns_per_row: 8
          committer_username: 'github-actions[bot]'
          committer_email: '41898282+github-actions[bot]@users.noreply.github.com'
          commit_message: 'docs: update contributors list'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Add contributor on PR merge
  add-contributor-pr:
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == true && github.event.pull_request.author_association != 'OWNER'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add contributor
        uses: all-contributors/all-contributors-cli@v1
        with:
          args: 'add ${{ github.event.pull_request.user.login }} code'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Add contributor on issue creation
  add-contributor-issue:
    if: github.event_name == 'issues' && github.event.action == 'opened' && github.event.issue.author_association != 'OWNER'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add contributor
        uses: all-contributors/all-contributors-cli@v1
        with:
          args: 'add ${{ github.event.issue.user.login }} bug'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Welcome new contributors
  welcome:
    if: github.event_name == 'pull_request_target' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Check if first contribution
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: author,
              state: 'all'
            });
            
            const isFirstContribution = prs.length === 1;
            return { isFirst: isFirstContribution };

      - name: Welcome new contributor
        if: fromJson(steps.check.outputs.result).isFirst
        uses: actions/github-script@v7
        with:
          script: |
            const message = `
            üéâ **Welcome to GenOps AI!** 

            Thank you for your first contribution to our project! We're excited to have you as part of our community.

            Here are some helpful resources:
            - üìñ [Contributing Guide](https://github.com/KoshiHQ/GenOps-AI/blob/main/CONTRIBUTING.md)
            - üí¨ [GitHub Discussions](https://github.com/KoshiHQ/GenOps-AI/discussions) for questions
            - üêõ Need help? Feel free to ask questions in this PR!

            Our maintainers will review your PR soon. In the meantime, you might want to:
            - ‚úÖ Make sure all CI checks pass
            - üìù Update documentation if needed
            - üß™ Add tests for new functionality

            Thanks for helping make AI governance better for everyone! üöÄ
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });